<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Greendash Dashboard</title>
    <!-- Iconic Fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="../vendors/iconic-fonts/font-awesome/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../vendors/iconic-fonts/flat-icons/flaticon.css">
    <link rel="stylesheet" href="../vendors/iconic-fonts/cryptocoins/cryptocoins.css">
    <link rel="stylesheet" href="../vendors/iconic-fonts/cryptocoins/cryptocoins-colors.css">
    <!-- Bootstrap core CSS -->
    <link href="http://cdn.bootstrapmb.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery UI -->
    <link href="../assets/css/jquery-ui.min.css" rel="stylesheet">
    <!-- Page Specific CSS (Slick Slider.css) -->
    <link href="../assets/css/slick.css" rel="stylesheet">
    <!-- Greendash styles -->
    <link href="../assets/css/style.css" rel="stylesheet">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.ico">

</head>

<body class="ms-body ms-aside-left-open ms-primary-theme ">

<!-- Overlays -->
<div class="ms-aside-overlay ms-overlay-left ms-toggler" data-target="#ms-side-nav" data-toggle="slideLeft"></div>

<!-- 大页面左边导航 -->
<aside id="ms-side-nav" class="side-nav fixed ms-aside-scrollable ms-aside-left">
    <!-- Logo -->
    <div id="logo" class="logo-sn ms-d-block-lg">
        <!-- logo的图片 -->
        <a class="pl-0 ml-0 text-center" href="index.html"> <img src="../assets/img/logo.png" alt="logo">
        </a>
    </div>

    <!-- 导航的一级菜单 -->
    <ul class="accordion ms-main-aside fs-14" id="side-nav-accordion">
        <!-- Dashboard -->
        <li class="menu-item">
            <a href="#" class="has-chevron" data-toggle="collapse" data-target="#dashboard" aria-expanded="false"
               aria-controls="dashboard">
                <span><i class="material-icons fs-16">dashboard</i>药品管理</span>
            </a>
            <ul id="dashboard" class="collapse" aria-labelledby="dashboard" data-parent="#side-nav-accordion">
                <li><a href="./gongyingshangxinxi.html">供应商信息管理</a></li>
                <li><a href="./yaopinxinxi.html">药品信息管理</a></li>
                <li><a href="./add_caigoudan.html">采购单添加</a></li>
                <li><a href="./caigoumingxi.html">采购明细管理</a></li>
            </ul>
        </li>
        <!--药品管理-->
        <li class="menu-item">
            <a href="#" class="has-chevron" data-toggle="collapse" data-target="#dashboard1" aria-expanded="false"
               aria-controls="dashboard1">
                <span><i class="material-icons fs-16">dashboard1</i>仪器管理</span>
            </a>
            <ul id="dashboard1" class="collapse" aria-labelledby="dashboard1" data-parent="#side-nav-accordion">
                <li><a href="./gongyingshangxinxi1.html">供应商信息管理</a></li>
                <li><a href="./yaopinxinxi1.html">仪器信息管理</a></li>
                <li><a href="./add_caigoudan1.html">采购单添加</a></li>
                <li><a href="./caigoumingxi1.html">采购明细管理</a></li>
            </ul>
        </li>
        <!--仪器管理-->
        <li class="menu-item">
            <a href="#" class="has-chevron" data-toggle="collapse" data-target="#order-page" aria-expanded="false"
               aria-controls="order-page">
                <span><i class="fas fa-clipboard-list"></i>病人管理</span>
            </a>
            <ul id="order-page" class="collapse" aria-labelledby="order-page" data-parent="#side-nav-accordion">
                <li><a href="./add_xiaoshoudan.html">病人信息添加</a></li>
                <li><a href="./xiaoshoumingxi.html">病人信息统计</a></li>
            </ul>
        </li>
        <!--病人管理-->
        <li class="menu-item">
            <a href="#" class="has-chevron" data-toggle="collapse" data-target="#product-page" aria-expanded="false"
               aria-controls="product-page">
                <span><i class="fas fa-cannabis"></i>病床统计管理</span>
            </a>
            <ul id="product-page" class="collapse" aria-labelledby="product-page" data-parent="#side-nav-accordion">
                <li><a href="./rukutongji.html">病床使用信息添加</a></li>
                <li><a href="./chukutongji.html">病床统计</a></li>
            </ul>
        </li>
        <!--病床管理-->
        <li class="menu-item">
            <a href="#" class="has-chevron" data-toggle="collapse" data-target="#customer" aria-expanded="false"
               aria-controls="customer">
                <span><i class="fas fa-users"></i>员工管理</span>
            </a>
            <ul id="customer" class="collapse" aria-labelledby="customer" data-parent="#side-nav-accordion">
                <li><a href="add_yuangong.html">员工添加</a></li>
                <li><a href="./yuangongguanli.html">员工管理</a></li>
            </ul>
        </li>
        <!--员工管理-->
        <li class="menu-item">
            <a href="#" class="has-chevron" data-toggle="collapse" data-target="#customer1" aria-expanded="false"
               aria-controls="customer1">
                <span><i class="fas fa-users"></i>部门管理</span>
            </a>
            <ul id="customer1" class="collapse" aria-labelledby="customer1" data-parent="#side-nav-accordion">
                <li><a href="add_yuangong1.html">部门员工添加</a></li>
                <li><a href="./yuangongguanli1.html">部门员工管理</a></li>
            </ul>
        </li>
        <!--部门管理-->
        <li class="menu-item">
            <a href="#" class="has-chevron" data-toggle="collapse" data-target="#invoice" aria-expanded="false"
               aria-controls="invoice">
                <span><i class="fas fa-receipt"></i>打印管理</span>
            </a>
            <ul id="invoice" class="collapse" aria-labelledby="invoice" data-parent="#side-nav-accordion">
                <li><a href="./ruKuDan.html">近期药品、仪器入库单</a></li>
                <li><a href="./chuKuDan.html">近期药品、仪器出库单</a></li>
            </ul>
        </li>
        <!--打印管理-->
        <li class="menu-item">
            <a href="#" class="has-chevron" data-toggle="collapse" data-target="#basic-elements" aria-expanded="false"
               aria-controls="basic-elements">
                <span><i class="material-icons fs-16">filter_list</i>系统管理</span>
            </a>
            <ul id="basic-elements" class="collapse" aria-labelledby="basic-elements" data-parent="#side-nav-accordion">
                <li><a href="./xiuGaiMiMa.html">修改密码</a></li>
            </ul>
        </li>
        <!--修改密码（管理员管理）-->
    </ul>
</aside>
    <!-- 主体页面内容 -->
    <main class="body-content">
        <div id="app">
        <!-- 主题页面顶部导航 -->
        <nav class="navbar ms-navbar">
            <div class="ms-aside-toggler ms-toggler pl-0" data-target="#ms-side-nav" data-toggle="slideLeft">
                <span class="ms-toggler-bar bg-primary"></span>
                <span class="ms-toggler-bar bg-primary"></span>
                <span class="ms-toggler-bar bg-primary"></span>
            </div>
            <div class="logo-sn logo-sm ms-d-block-sm">
                <a class="pl-0 ml-0 text-center navbar-brand mr-0" href="index.html"><img
                        src="../assets/img/dashboard/greendash-logo-84x41.png" alt="logo"> </a>
            </div>
            <!-- 搜索 -->
            <div style="display:flex;align-content:center;">
                 <div style="line-height:60px;font-size: 18px;"><span id="loginSuName">{{username}}</span>,欢迎你</div>
                 <div id="outLogin"><a href="javascript:void(0);" id="logOut"  @click="logout">退出登录</a></div>
            </div>


        </nav>

        <!-- 内容区域 -->
        <div class="ms-content-wrapper">
            <div class="row">
                <!-- 分页标 -->
                <div class="col-md-12">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb pl-0">
                            <li class="breadcrumb-item"><a href="./index.html">首页</a></li>
                            <li class="breadcrumb-item"><a href="./caigoumingxi.html">采购明细</a></li>
                        </ol>
                    </nav>
                    <label>
                        搜索：<input type="text" name="search" id="search" @input="search($event)">&nbsp;&nbsp;
                    </label>
                </div>
                <!-- 方块下的表格 -->
                <div class="col-xl-12 col-md-12">
                    <div class="ms-panel">
                        <div class="ms-panel-body">
                            <div class="table-responsive">
                                <table class="mytable table table-hover thead-primary">
                                    <thead>
                                        <tr>
                                            <th>采购单据号</th>
                                            <th>入库时间</th>
                                            <th>总金额</th>
                                            <th>负责人</th>
                                            <th>备注</th>
                                            <th>明细</th>
                                            <th>删除</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="buyinformation in buyinformationList">
                                            <td>{{buyinformation.number}}</td>
                                            <td>{{buyinformation.time}}</td>
                                             <td>{{buyinformation.money}}</td>
                                             <td>{{buyinformation.people}}</td>
                                             <td>{{buyinformation.psbuy}}</td>
                                             <td>{{buyinformation.mingxi}}</td>
                                             <td><span class='btn_del' @click="deleteDrug(buyinformation.id)"><i class="far fa-trash-alt ms-text-danger ml-3" ></i></span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 查看采购明细 -->
        <div class="modal fade" id="cgmxModal" tabindex="-1" role="dialog"
             aria-labelledby="reminder-modal-select">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">

                    <div class="modal-header bg-secondary">
                        <h5 class="modal-title has-icon text-white">采购明细</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table id="mycgmx" class="table table-hover thead-primary">
                                <thead>
                                <tr>
                                    <th>药品名称</th>
                                    <th>数量</th>
                                    <th>备注</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 添加采购明细 -->
        <div class="modal fade" id="addCgmxModal" tabindex="-1" role="dialog"
            aria-labelledby="reminder-modal-add">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header bg-secondary">
                        <h5 class="modal-title has-icon text-white">添加采购明细</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                    </div>
                    <form id="addCgmx">
                        <div class="modal-body">
                            <!--库存ID-->
                            <input type="hidden" id="ruku_id" name="ruku_id">

                            <div class="ms-form-group">
                                <label for="validationCustom01">药品类别</label>
                                <div class="input-group">
                                    <select class="form-control" id="validationCustom01" name="catelog_id" required="required">
                                        <option value="-1" disabled selected>---请选择---</option>
                                    </select>
                                </div>
                            </div>
                            <div class="ms-form-group">
                                <label for="validationCustom02">药品名称</label>
                                <div class="input-group">
                                    <select class="form-control" id="validationCustom02" name="goods_id" required="required">
                                        <!--<option value="-1">-&#45;&#45;请选择-&#45;&#45;</option>-->
                                    </select>
                                </div>
                            </div>
                            <div class="ms-form-group">
                                <label>采购数量</label>
                                <input type="text" class="form-control" name="shuliang" />
                            </div>

                            <div class="ms-form-group">
                                <label>备注</label>
                                <input type="text" class="form-control" name="beizhu" />
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-light" data-dismiss="modal">关闭</button>
                            <button type="button" class="addCgmxBtn btn btn-secondary shadow-none" data-dismiss="modal">添加</button>
                        </div>

                    </form>

                </div>
            </div>
        </div>
    </div>
    </main>
    <!-- SCRIPTS -->
    <!-- Global Required Scripts Start -->
    <script src="../assets/js/jquery-3.3.1.min.js"></script>
    <script src="../assets/js/popper.min.js"></script>
    <script src="http://cdn.bootstrapmb.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script src="../assets/js/perfect-scrollbar.js"> </script>
    <script src="../assets/js/jquery-ui.min.js"> </script>
    <!-- Global Required Scripts End -->

    <!-- Page Specific Scripts Start -->
    <script src="../assets/js/moment.js"> </script>
    <script src="../assets/js/jquery.webticker.min.js"> </script>
    <!--  <script src="../assets/js/Chart.bundle.min.js"> </script>-->
    <!--  <script src="../assets/js/Chart.Financial.js"> </script>-->
    <!--  <script src="../assets/js/table-line.js"> </script>-->
    <!--  <script src="../assets/js/index-chart.js"> </script>-->

    <script src="../assets/js/d3.v3.min.js"> </script>
    <script src="../assets/js/topojson.v1.min.js"> </script>
    <!--  <script src="../assets/js/datamaps.all.min.js"> </script>-->
    <!--  <script src="../assets/js/index-map.js"> </script>-->






    <!-- Page Specific Scripts End -->

    <!-- Greendash core JavaScript -->
    <script src="../assets/js/framework.js"></script>

    <!-- Settings -->
    <script src="../assets/js/settings.js"></script>
    <script src="../assets/js/vue.js"></script>
    <script src="../assets/js/axios.min.js"></script>
    <script type="text/javascript">
        //获取数值
        var vm = new Vue({
           el:"#app",
           data:{
               username:"",
               buyinformationList:[],
               number:'',
               time:'',
               money:'',
               people:'',
               psbuy:'',
               mingxi:''

           },

           //退出账号，返回登录界面
           methods: {
                logout:function(){
                    if(confirm("是否确定要退出?")) {
                        //销毁localstorage中的内容
                        localStorage.clear();
                        //跳转到登录页
                        window.location.reload();
                    }
                },

                //添加操作
                add:function(){
                   //发送请求 给后端
                   axios.post('http://localhost:8080/buyinformation/add',`name=${this.name}&address=${this.address}&link=${this.link}&phone=${this.phone}&code=${this.code}&fax=${this.fax}&email=${this.email}`).then(
                        response => {
                        if(response.data.code==200){//登录成功 ,里面一定有带过来的user response.data.data
                            window.location.reload();
                        
                        }else{
                            alert(response.data.msg);

                        }
                        
                        },
                        error => {console.log('失败了',error);}
                    )

                },
                             //删除操作
                deleteDrug:function(id){
                   //发送axios请求将id 发送到后端
                   if(confirm("是否确定要删除?")){
                    axios.post('http://localhost:8080/buyinformation/delete',`id=${id}`).then(
                        response => {
                            if(response.data.code==200){//登录成功 ,里面一定有带过来的user response.data.data
                              window.location.reload();
                            
                            }else{
                                alert(response.data.msg);

                            }
                            
                            },
                            error => {console.log('失败了',error);}
                        )
                    }

                   },

               //查找
               search(event){
                   var search =event.currentTarget.value;
                   if (search===""){
                       axios.get('http://localhost:8080/buyinformation/query').then(
                           response => {
                               this.buyinformationList = response.data.data;
                           },
                           error => {console.log('请求失败了',error);}
                       )
                   }
                   else{
                       axios.post('http://localhost:8080/buyinformation/queryByName',`search=${search}`).then(
                           response => {
                               this.buyinformationList = response.data.data;
                           },
                           error => {console.log('请求失败了',error);}
                       )
                   }
               }
                  
            },
           //获取欢迎您前面的
           created() {
                //从localStorage取出来  var aa = {"id":10,"name":"aa"}
                var userJsonStr = localStorage.getItem("user");

                if(userJsonStr != null){
                //转换为json对象 {id:10,name:"aa"}
                    var userObj = $.parseJSON(userJsonStr);
                    this.username = userObj.name;


                    //发送ajax请求
                    axios.get('http://localhost:8080/buyinformation/query').then(
                        response => {
                           this.buyinformationList = response.data.data;
                        },
                        error => {console.log('请求失败了',error);}
                    )


                }else{
                 location.href = "./login.html";
                }

            }


        })


        $(function () {
            //登录成功后，将登录名称显示。
            
            function timestampToTime(timestamp) {
                var date = new Date(timestamp);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
                var Y = date.getFullYear() + '-';
                var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
                var D = date.getDate() + ' ';
                var h = date.getHours() + ':';
                var m = date.getMinutes() + ':';
                var s = date.getSeconds();
//                return Y + M + D + h + m + s;
                return Y + M + D;
            }
            //获取采购人
            $.ajax({
                url:"/queryRuKuList",
                type:"get",
                dataType:"json",
                success:function(res){
                    if(res.code == 200){
                        $.each(res.data,function(index,item){
                            //采用ES6动态加载数据
                            $(".mytable tbody").append(`
                                <tr>
                                    <td>${item.danjuhao}</td>
                                    <td>${(timestampToTime(item.shijian))}</td>
                                    <td>${item.zongjiage}</td>
                                    <td>${item.jingshouren}</td>
                                    <td>${item.beizhu}</td>
                                    <td
                                        style="display: flex; justify-content: space-around;cursor: pointer; color: red;">
                                        <a data-toggle="modal" data-target="#cgmxModal" data-whatever="${item.id}">采购明细</a>
                                        <a data-toggle="modal" data-target="#addCgmxModal" data-whatever="${item.id}">添加采购明细</a>
                                    </td>
                                    <td><span class='rk_btn_del' data-id="${item.id}"><i class="far fa-trash-alt ms-text-danger ml-3" ></i></span></td>
                                </tr>
                            `)
                        });
                    }
                    if(res.code == 500){
                        alert(res.msg)
                    }
                }
            })

            //点击模态框传数据采购明细
            $('#cgmxModal').on('show.bs.modal', function (event) {
                  var button = $(event.relatedTarget) // Button that triggered the modal
                  var recipient = button.data('whatever') //点击采购明细后，获取到入库ID
                 $("#mycgmx tbody").empty().append()
                 var modal = $(this);
                 //获取采购明细
                 $.ajax({
                    url:"/queryCaiGouMingXiList",
                    type:"get",
                    data:{ruku_id:recipient},
                    dataType:"json",
                    success:function(res){
                        if(res.code == 200){//登录成功
                            $.each(res.data,function(index,item){
                                modal.find('#mycgmx tbody').append(`
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.shuliang}</td>
                                        <td>${item.beizhu}</td>
                                        <td><span class='cgmx_btn_del' data-id="${item.id}"><i class="far fa-trash-alt ms-text-danger ml-3" ></i></span></td>
                                    </tr>
                               `)
                            });
                        }
                        if(res.code == 500){
                            alert(res.msg)
                        }
                    }
                })

//
            })

            //药品类别
            $.ajax({
                url:"/queryCatelogList",
                type:"get",
                dataType:"json",
                success:function(res){
                    if(res.code == 200){//登录成功
                        $.each(res.data,function(index,item){
                            //采用ES6动态加载数据
                            $("#validationCustom01").append(`
                             <option value="${item.id}">${item.name}</option>
                            `)
                        });
                    }
                    if(res.code == 500){
                        alert(res.msg)
                    }
                }
            })

            //下拉别表选中触发
            $("#validationCustom01").on("change",function(){
                var catelog_id = $("#validationCustom01 option:selected").val();
                $("#validationCustom02").empty().append();//每次选择之前先清空药品名称
                //药品类别
                $.ajax({
                    url:"/queryYaoPinListByCatelogId",
                    type:"get",
                    data:{catelog_id:catelog_id},
                    dataType:"json",
                    success:function(res){
                        if(res.code == 200){
                            if(res.data.length == 0){//如果无二级数据
                                //采用ES6动态加载数据
                                $("#validationCustom02").append(`
                                   <option value="-1" disabled>--无药品选择--</option>
                                `)
                            }

                            $.each(res.data,function(index,item){
                                //采用ES6动态加载数据
                                $("#validationCustom02").append(`
                                   <option value="${item.id}">${item.name}</option>
                                `)
                            });
                        }
                        if(res.code == 500){
                            alert(res.msg)
                        }
                    }
                })


            })

            //添加采购明细_点击赋值ruku_id
            $('#addCgmxModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget) // Button that triggered the modal
                var recipient = button.data('whatever') //点击采购明细后，获取到入库ID
                $("#ruku_id").empty().append()
                var modal = $(this);
                modal.find("#ruku_id").val(recipient)
            })

            //添加采购明细
            $(".addCgmxBtn").click(function(){
                $.ajax({
                    url: "/addCaiGouMingXi",
                    type: "post",
                    data: $("#addCgmx").serialize(),
                    dataType: "json",
                    success: function (res) {
                        if(res.code == 200){
                            alert(res.msg)
                            //刷新
                            location.reload();
                        }
                        if(res.code == 500){
                            alert(res.msg)
                        }
                    }
                });
            });

            //删除采购单
            $('.mytable').on('click','.rk_btn_del',function () {
                if(confirm("确定删除么？")){
                    var id = $(this).attr("data-id");
                    $.ajax({
                        url:"/delCaiGouXxByDjh",
                        type:"post",
                        data:{id:id},
                        dataType:"json",
                        success:function(res){
                            if(res.code == 200){//登录成功
                                alert(res.msg)
                                //刷新
                                location.reload();
                            }
                            if(res.code == 500){
                                alert(res.msg)
                            }
                        }
                    })
                }
            })

            //删除采购明细
            $('#mycgmx').on('click','.cgmx_btn_del',function () {
                if(confirm("确定删除么？")){
                    var id = $(this).attr("data-id");
                    $.ajax({
                        url:"/delCaiGouMx",
                        type:"post",
                        data:{goods_id:id},
                        dataType:"json",
                        success:function(res){
                            if(res.code == 200){//登录成功
                                alert(res.msg)
                                //刷新
                                location.reload();
                            }
                            if(res.code == 500){
                                alert(res.msg)
                            }
                        }
                    })
                }
            })




        })




    </script>

</body>

</html>